var QBTable=function(){"use strict";var t=0,e=0,r=3;"undefined"==typeof window.QuickBase&&(window.QuickBase={},$("<script />",{type:"text/javascript",src:"https://cdn.datacollaborative.com/js/quickbase/quickbase.browserify.min.js"}).appendTo("head")),"undefined"==typeof window.QBRecord&&(window.QBRecord={},$("<script />",{type:"text/javascript",src:"https://cdn.datacollaborative.com/js/qb-record/QBRecord.min.js"}).appendTo("head"));var i={quickbase:{realm:window.location.host.split(".")[0],appToken:""},dbid:function(){var t=window.location.pathname.match(/^\/db\/(?!main)(.*)$/);return t?t[1]:""}(),query:"",fids:{recordid:3,primaryKey:3},slist:"",options:""},n=function(t){this._dbid="",this._query="",this._fids={},this._slist="",this._options="",this._data={records:[]};var e=this,r=function(){t&&t.quickbase instanceof QuickBase&&(e._qb=t.quickbase,delete t.quickbase);var r=$.extend(!0,{},i,t||{});e.setDBID(r.dbid).setQuery(r.query).setFids(r.fids).setSList(r.slist).setOptions(r.options),e._qb||(e._qb=new QuickBase(r.quickbase))};if("function"==typeof QuickBase)r();else var n=setInterval(function(){return-1!==["function"==typeof QuickBase].indexOf(!1)?!1:(clearInterval(n),void r())});return this};n.prototype.clear=function(){return this._data={records:[]},this},n.prototype.deleteRecord=function(t,e){var r=this,i=this.getRecords(),n=o(i,e||"recordid",t);if(-1===n)return this;var s=r._data.records.splice(n,1);return s["delete"]().then(function(t){return r})["catch"](function(t){throw r._data.records.push(s),t})},n.prototype.deleteRecords=function(t){var e=this;if(t)return QuickBase.Promise.map(this.getRecords(),function(t){return e.deleteRecord(t.get("recordid"))});var r=this._data.records.splice(0,this.getNRecords());return this._qb.api("API_PurgeRecords",{dbid:this.getDBID(),query:[].concat(localQuery||[],this.getQuery()).join("AND")}).then(function(){return e})["catch"](function(t){throw e._data.records=e._data.records.concat(r),t})},n.prototype.getDBID=function(){return this._dbid},n.prototype.getFid=function(t,e){var r=this.getFids(),i=-1;return e!==!0?r.hasOwnProperty(t)&&(i=r[t]):(t=+t,Object.keys(r).some(function(e){return r[e]===t?(i=e,!0):!1})),i},n.prototype.getFids=function(t){return this._fids},n.prototype.getField=function(t){var e=this.getFields(),r=o(e,"id",+t);if(-1!==r)return e[r]},n.prototype.getFields=function(){return this._data.fields},n.prototype.getNRecords=function(){return this._data.records.length},n.prototype.getOptions=function(t){return this._options},n.prototype.getQuery=function(t){return this._query},n.prototype.getSList=function(t){return this._slist},n.prototype.getRecord=function(t,e,r){var i=this.getRecords(),n=-1;return i.some(function(r,i){return r.get(e)!==t?!1:(n=i,!0)}),r?n:-1!==n?i[n]:void 0},n.prototype.getRecords=function(){return this._data.records},n.prototype.load=function(t){var e=this,r=this.getDBID(),i=this.getFids();return this._qb.api("API_DoQuery",{dbid:r,query:[].concat(t||[],this.getQuery()).join("AND"),clist:Object.keys(i).map(function(t){return i[t]}),slist:this.getSList(),options:this.getOptions(),includeRids:!0}).then(function(t){return e._data=t.table,e._data.records=e._data.records.map(function(t){return new QBRecord({quickbase:e._qb,dbid:r,fids:i,recordid:t.rid})}),e})},n.prototype.save=function(t){var e=this;if(t)return QuickBase.Promise.map(this.getRecords(),function(t){return t.save()}).then(function(){return e});var r=this.getFids(),i=Object.keys(r),n=this.getRecords(),o=[r.recordid];return i.forEach(function(t){var i=r[t],n=e.getField(i);5>=i||-1!==["summary","virtual","lookup"].indexOf(n.mode)||o.push(i)}),this._qb.api("API_ImportFromCSV",{dbid:this.getDBID(),clist:o,records_csv:n.reduce(function(t,r){return t.concat(o.reduce(function(t,i){var n=e.getFid(i,!0),o=r.get(n);return null===o&&(o=""),t.concat(c(o))},[]).join(","))},[]).join("\n")}).then(function(t){return n.forEach(function(e,r){e.set("recordid",t.rids[r])}),e})},n.prototype.setDBID=function(t){return this._dbid=t,this.getRecords().forEach(function(e){e.setDBID(t)}),this},n.prototype.setFid=function(t,e){return this._fids[t]=+e,this.getRecords().forEach(function(r){r.setFid(t,e)}),this},n.prototype.setFids=function(t){var e=this;return Object.keys(t).forEach(function(r){e.setFid(r,t[r])}),this},n.prototype.setOptions=function(t){return this._options=t,this},n.prototype.setQuery=function(t){return this._query=t,this},n.prototype.setSList=function(t){return this._slist=t,this},n.prototype.upsertRecord=function(t,e){var r=this,i=void 0,n=function(){Object.keys(t).forEach(function(e){i.set(e,t[e])})};return t||(t={}),t.recordid?i=this.getRecord(t.recordid,"recordid"):t.primaryKey&&(i=this.getRecord(t.primaryKey,"primaryKey")),i?n():(i=new QBRecord({quickbase:this._qb,dbid:this.getDBID(),fids:this.getFids()}),n(),this._data.records.push(i)),e===!0?i.save().then(function(){return r}):this};var o=function(t,e,r){if("object"!=typeof t)return-1;for(var i,n=0,o=t.length,c=0,d=0;o>n;++n)if("object"==typeof e){for(i=new Array(e.length),i=s(i,!1),c=0,d=i.length;d>c;++c)t[n][e[c]]===r[c]&&(i[c]=!0);if(-1===i.indexOf(!1))return n}else if(t[n][e]===r)return n;return-1},s=function(t,e){for(var r=0;r<t.length;++r)t[r]=e;return t},c=function(t){return t?("number"==typeof t||!isNaN(t)&&isFinite(t)&&!t.match(/e/)||(t.match(/e/)&&(t=t.toString()),t=t.replace(/\"/g,'""').replace(/\&/g,"&amp;"),t='"'+t+'"'),t):t};return n.VERSION=[t,e,r].join("."),n}();
