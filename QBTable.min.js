var QBTable=function(){"use strict";var t=0,e=2,r=0;"undefined"==typeof window.QuickBase&&(window.QuickBase={},$("<script />",{type:"text/javascript",src:"https://cdn.datacollaborative.com/js/quickbase/quickbase.browserify.min.js"}).appendTo("head")),"undefined"==typeof window.QBRecord&&(window.QBRecord={},$("<script />",{type:"text/javascript",src:"https://cdn.datacollaborative.com/js/qb-record/QBRecord.min.js"}).appendTo("head"));var i={quickbase:{realm:window.location.host.split(".")[0],appToken:""},dbid:function(){var t=window.location.pathname.match(/^\/db\/(?!main)(.*)$/);return t?t[1]:""}(),query:"",fids:{recordid:3,primaryKey:3},slist:"",options:""},o=function(t){this._dbid="",this._query="",this._fids={},this._slist="",this._options="",this._data={records:[]};var e=this,r=function(){t&&t.quickbase instanceof QuickBase&&(e._qb=t.quickbase,delete t.quickbase);var r=$.extend(!0,{},i,t||{});e.setDBID(r.dbid).setQuery(r.query).setFids(r.fids).setSList(r.slist).setOptions(r.options),e._qb||(e._qb=new QuickBase(r.quickbase))};if("function"==typeof QuickBase)r();else var o=setInterval(function(){return-1!==["function"==typeof QuickBase].indexOf(!1)?!1:(clearInterval(o),void r())});return this};o.prototype.clear=function(){return this._data={records:[]},this},o.prototype.deleteRecord=function(t){var e=this,r=-1;if(this.getRecords().some(function(e,i){return t._id===e._id?(r=i,!0):!1}),-1===r)return this;var t=this._data.records.splice(r,1)[0];return t.get("recordid")?t["delete"]().then(function(t){return e})["catch"](function(r){throw e._data.records.push(t),r}):QuickBase.Promise.resolve()},o.prototype.deleteRecords=function(t){var e=this;if(t)return QuickBase.Promise.map(this.getRecords(),function(t){return e.deleteRecord(t)});var r=this._data.records.splice(0,this.getNRecords());return this._qb.api("API_PurgeRecords",{dbid:this.getDBID(),query:[].concat(localQuery||[],this.getQuery()).join("AND")}).then(function(){return e})["catch"](function(t){throw e._data.records=e._data.records.concat(r),t})},o.prototype.getDBID=function(){return this._dbid},o.prototype.getFid=function(t,e){var r=this.getFids(),i=-1;return e!==!0?r.hasOwnProperty(t)&&(i=r[t]):(t=+t,Object.keys(r).some(function(e){return r[e]===t?(i=e,!0):!1})),i},o.prototype.getFids=function(t){return this._fids},o.prototype.getField=function(t){var e=this.getFields(),r=n(e,"id",+t);if(-1!==r)return e[r]},o.prototype.getFields=function(){return this._data.fields},o.prototype.getNRecords=function(){return this._data.records.length},o.prototype.getOptions=function(t){return this._options},o.prototype.getQuery=function(t){return this._query},o.prototype.getSList=function(t){return this._slist},o.prototype.getTableName=function(){return this._data.name},o.prototype.getRecord=function(t,e,r){var i=this.getRecords(),o=-1;return i.some(function(r,i){return r.get(e)!==t?!1:(o=i,!0)}),r?o:-1!==o?i[o]:void 0},o.prototype.getRecords=function(){return this._data.records},o.prototype.load=function(t){var e=this,r=this.getDBID(),i=this.getFids();return this._qb.api("API_DoQuery",{dbid:r,query:[].concat(t||[],this.getQuery()).join("AND"),clist:Object.keys(i).map(function(t){return i[t]}),slist:this.getSList(),options:this.getOptions(),includeRids:!0}).then(function(t){return e._data=t.table,e._data.records=e._data.records.map(function(t){var o=new QBRecord({quickbase:e._qb,dbid:r,fids:i,recordid:t.rid});return Object.keys(i).forEach(function(e){o.set(e,t[i[e]])}),o._fields=e._data.fields,o}),e})},o.prototype.save=function(t){var e=this;if(t)return QuickBase.Promise.map(this.getRecords(),function(t){return t.save()}).then(function(){return e});var r=this.getFids(),i=Object.keys(r),o=this.getRecords(),n=[r.recordid];i.forEach(function(t){var i=r[t],o=e.getField(i);5>=i||o&&-1!==["summary","virtual","lookup"].indexOf(o.mode)||n.push(i)});var s=o.reduce(function(t,r){return t.concat(n.reduce(function(t,i){var o=e.getFid(i,!0),n=r.get(o);return null===n&&(n=""),t.concat(c(n))},[]).join(","))},[]).join("\n");return 0===s.length?QuickBase.Promise.resolve():this._qb.api("API_ImportFromCSV",{dbid:this.getDBID(),clist:n,records_csv:s}).then(function(t){return o.forEach(function(e,r){e.set("recordid",t.rids[r].rid)}),e})},o.prototype.setDBID=function(t){return this._dbid=t,this.getRecords().forEach(function(e){e.setDBID(t)}),this},o.prototype.setFid=function(t,e){return this._fids[t]=+e,this.getRecords().forEach(function(r){r.setFid(t,e)}),this},o.prototype.setFids=function(t){var e=this;return Object.keys(t).forEach(function(r){e.setFid(r,t[r])}),this},o.prototype.setOptions=function(t){return this._options=t,this},o.prototype.setQuery=function(t){return this._query=t,this},o.prototype.setSList=function(t){return this._slist=t,this},o.prototype.upsertRecord=function(t,e){var r=this,i=void 0,o=function(){Object.keys(t).forEach(function(e){i.set(e,t[e])}),i._fields=r._data._fields};return t||(t={}),t.recordid?i=this.getRecord(t.recordid,"recordid"):t.primaryKey&&(i=this.getRecord(t.primaryKey,"primaryKey")),i?o():(i=new QBRecord({quickbase:this._qb,dbid:this.getDBID(),fids:this.getFids()}),o(),this._data.records.push(i)),e===!0?i.save().then(function(){return i}):QuickBase.Promise.resolve(i)};var n=function(t,e,r){if("object"!=typeof t)return-1;for(var i,o=0,n=t.length,c=0,d=0;n>o;++o)if("object"==typeof e){for(i=new Array(e.length),i=s(i,!1),c=0,d=i.length;d>c;++c)t[o][e[c]]===r[c]&&(i[c]=!0);if(-1===i.indexOf(!1))return o}else if(t[o][e]===r)return o;return-1},s=function(t,e){for(var r=0;r<t.length;++r)t[r]=e;return t},c=function(t){return t?("boolean"==typeof t&&(t=t?1:0),"number"==typeof t||!isNaN(t)&&isFinite(t)&&!t.match(/e/)||(t.match(/e/)&&(t=t.toString()),t=t.replace(/\"/g,'""').replace(/\&/g,"&amp;"),t='"'+t+'"'),t):t};return o.VERSION=[t,e,r].join("."),o}();
